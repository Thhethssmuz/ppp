% ------------------------ D O C U M E N T   C L A S S ------------------------
  \RequirePackage[hyphens]{url}

  \documentclass[]{$documentclass$}

  % page size
  \KOMAoptions{
    paper=$if(page-size)$$page-size$$else$a4$endif$,
    pagesize=auto
  }

  % page layout
  \KOMAoptions{
    twoside=$if(page-twoside)$true$else$false$endif$,
    twocolumn=false,
    DIV=$if(page-div)$$page-div$$else$10$endif$,
    BCOR=$if(page-bcor)$$page-bcor$$else$0mm$endif$
  }

% ----------------------------- F O N T  S P E C ------------------------------
  \KOMAoptions{fontsize=$if(font-size)$$font-size$$else$12pt$endif$}

  \usepackage[T1]{fontenc}
  \usepackage{lmodern}
  \usepackage{amssymb,amsmath}
  \usepackage{fixltx2e}
  \IfFileExists{microtype.sty}{\usepackage{microtype}}{}
  \IfFileExists{upquote.sty}{\usepackage{upquote}}{}
  \usepackage{mathspec}% imports fontspec
  \usepackage{xltxtra,xunicode}
  \defaultfontfeatures{Mapping=tex-text,Scale=MatchLowercase}
  %\newcommand{\euro}{â‚¬}
  \setmainfont{$if(main-font)$$main-font$$else$Open Sans$endif$}
  \setsansfont{$if(sans-font)$$sans-font$$else$Open Sans$endif$}
  \setmonofont{$if(mono-font)$$mono-font$$else$Ubuntu Mono$endif$}
  $if(math-font)$\setmathfont{$math-font$}$endif$
  \usepackage{pifont}

% ---------------- P A G E   H E A D E R   A N D   F O O T E R ----------------
  \usepackage{lastpage}
  \newcommand\lastpagemark{\pageref{LastPage}}

  \usepackage{ifthen}
  \ifthenelse{
    \equal{$page-header-left$$page-header-centre$$page-header-right$}{}
  }{\usepackage[nouppercase]{scrpage2}
  }{\usepackage[nouppercase,headsepline]{scrpage2}}

  \pagestyle{scrheadings}

  % header and footer font styles
  \setkomafont{pagehead}{}
  \setkomafont{pagefoot}{}
  \setkomafont{pagenumber}{}

  $if(report)$
  \automark[chapter]{chapter}
  $endif$

  $if(page-twoside)$
  \lehead[]{$page-header-left$}
  \cehead[]{$page-header-centre$}
  \rehead[]{$page-header-right$}
  \lohead[]{$page-header-right$}
  \cohead[]{$page-header-centre$}
  \rohead[]{$page-header-left$}

  \lefoot[$if(page-footer-left)$$page-footer-left$$else$\itshape \pagemark$endif$]
         {$if(page-footer-left)$$page-footer-left$$else$\itshape \pagemark$endif$}
  \cefoot[$page-footer-centre$]{$page-footer-centre$}
  \refoot[$page-footer-right$]{$page-footer-right$}
  \lofoot[$page-footer-right$]{$page-footer-right$}
  \cofoot[$page-footer-centre$]{$page-footer-centre$}
  \rofoot[$if(page-footer-left)$$page-footer-left$$else$\itshape \pagemark$endif$]
         {$if(page-footer-left)$$page-footer-left$$else$\itshape \pagemark$endif$}
  $else$
  \ohead[]{$page-header-left$}
  \chead[]{$page-header-centre$}
  \ihead[]{$page-header-right$}

  \ofoot[$page-footer-left$]{$page-footer-left$}
  \cfoot[$if(page-footer-centre)$$page-footer-centre$$else$\itshape \pagemark$endif$]
        {$if(page-footer-centre)$$page-footer-centre$$else$\itshape \pagemark$endif$}
  \ifoot[$page-footer-right$]{$page-footer-right$}
  $endif$

% ---------------------------------- M I S C ----------------------------------
  \usepackage{listings}
  \usepackage{longtable,booktabs}
  \usepackage{lipsum}
  \usepackage{fp}
  \usepackage{xparse}
  \usepackage{hyperref}
  \usepackage{bookmark}
  \usepackage[normalem]{ulem}

  % convenience function for class dependant clearpage
  \newcommand\pppclear{
    $if(report)$
    \clearpage
    $endif$

    $if(journal)$
    \clearpage
    $endif$

    $if(book)$
    \cleardoublepage
    $endif$
  }

% ------------------------------ L A N G U A G E ------------------------------
  $if(lang)$
  \usepackage{polyglossia}
  \setmainlanguage{$lang$}
  $endif$

  \AtBeginDocument{
    \defcaptionname{norsk,nynorsk}{\abstractname}{Abstrakt}
    \defcaptionname{norsk,nynorsk}{\appendixname}{Vedlegg}
    \defcaptionname{english,british,american}{\appendixpagename}{Appendices}
    \defcaptionname{norsk,nynorsk}{\appendixpagename}{Vedlegg}
    \defcaptionname{norsk,nynorsk}{\appendixtocname}{Vedlegg}
    \defcaptionname{english,british,american}{\equationname}{Equation}
    \defcaptionname{norsk}{\equationname}{Ligning}
    \defcaptionname{nynorsk}{\equationname}{Likning}
    \defcaptionname{english,british,american}{\examplename}{Example}
    \defcaptionname{norsk,nynorsk}{\examplename}{Eksempel}
    \defcaptionname{english,british,american}{\keywordsname}{Keywords}
    \defcaptionname{norsk}{\keywordsname}{Nøkelord}
    \defcaptionname{nynorsk}{\keywordsname}{Nykelord}
    \defcaptionname{english,british,american}{\listequationname}{List of Equations}
    \defcaptionname{norsk}{\listequationname}{Ligninger}
    \defcaptionname{nynorsk}{\listequationname}{Likningar}
    \defcaptionname{english,british,american}{\listexamplename}{List of Examples}
    \defcaptionname{norsk,nynorsk}{\listexamplename}{Eksempel}
    \defcaptionname{english,british,american}{\listprogramname}{List of Programs}
    \defcaptionname{norsk,nynorsk}{\listprogramname}{Program}
    \defcaptionname{norsk}{\notesname}{Noter}
    \defcaptionname{nynorsk}{\notesname}{Notar}
    \defcaptionname{english,british,american,norsk,nynorsk}{\programname}{Program}

    $for(language-terms)$
    $language-terms$
    $endfor$
  }

% ---------------------------- P A R A G R A P H S ----------------------------
  %\setlength{\parindent}{0pt}
  %\setlength{\parskip}{6pt plus 2pt minus 1pt}
  \setlength{\emergencystretch}{3em}

  \KOMAoptions{parskip=half}

% ---------------------- S E C T I O N   S E T T I N G S ----------------------
  %\KOMAoptions{
  %  chapterprefix=true, %false,
  %  headings=openany %open? for book
  %}

  % default no numbering of sections
  \setcounter{secnumdepth}{-2}

  % inline section number function
  \newcommand\numdepth[1]{
    \FPeval{\result}{clip(#1 $if(article)$$else$- 1$endif$)}
    \setcounter{secnumdepth}{\result}
  }

% --------------------------------- L I N K S ---------------------------------
  \hypersetup{
    setpagesize=false,
    unicode=false,
    xetex
  }

  \hypersetup{
    breaklinks=true,
    colorlinks=true,
    urlcolor=blue,
    linkcolor=black,
    pdfborder={0 0 0}
  }

  \hypersetup{
    bookmarks=true,
    bookmarksdepth=3,
    bookmarksopen=true,
    bookmarksopenlevel=0
  }

% -------------------------------- B L O C K S --------------------------------
  \usepackage{multicol}
  \usepackage{graphicx}
  \usepackage{float}
  \usepackage{wrapfig}
  \usepackage{caption}
  \usepackage{subcaption}
  \usepackage{dblfloatfix}

  \setcapindent{1em}
  \captionsetup{labelfont={bf,small},margin=1em}
  \captionsetup[subfigure]{margin=0.5em}
  \captionsetup[subtable]{margin=0.5em}

  \newcommand\pppnewfloat[1]{
    \newfloat{#1}{tbh}{#1}[$if(report)$chapter$else$section$endif$]
    \floatname{#1}{\csname#1name\endcsname}
    \DeclareCaptionSubType{#1}
    \captionsetup[sub#1]{margin=0.5em}
  }
  \pppnewfloat{equation}
  \pppnewfloat{example}
  \pppnewfloat{program}

  \newfloat{misc}{tbh}{misc}[$if(report)$chapter$else$section$endif$]
  \DeclareCaptionSubType*{misc}
  \captionsetup[misc]{indention=0em,margin=1em}
  \captionsetup[submisc]{indention=0em,margin=0.5em}

  % wrapper for multicols
  \newenvironment{pppmulticol}
    {$if(page-columns)$\begin{multicols}{$page-columns$}$endif$}
    {$if(page-columns)$\end{multicols}$endif$}

  $if(highlighting-macros)$
  $highlighting-macros$
  $endif$

  % fix for longtable table counter bug
  \makeatletter
  \newif\ifLT@nocaption
  \preto\longtable{\LT@nocaptiontrue}
  \appto\endlongtable{%
    \ifLT@nocaption
      \addtocounter{table}{\m@ne}%
    \fi}
  \preto\LT@caption{%
    \noalign{\global\LT@nocaptionfalse}}
  \makeatother

  % codeblocks inside multicols
  \newenvironment{lengthProtection}{%
    \setlength{\floatsep}{0pt}
    \setlength{\textfloatsep}{0pt}
    \setlength{\intextsep}{0pt}
    \setlength{\dbltextfloatsep}{0pt}
    \setlength{\dblfloatsep}{0pt}
    \setlength{\abovecaptionskip}{0pt}
    \setlength{\belowcaptionskip}{0pt}
  }{}
  \newcommand\pppcaptionof[1]{
    \vspace{12pt}
    \begin{lengthProtection}
      \captionof{program}{#1}
    \end{lengthProtection}
    \vspace{-12pt}
  }
  \newenvironment{unShaded}$if(page-columns)${%
    \provideenvironment{Shaded}{}{}
    \renewenvironment{Shaded}{}{}
    \vspace{6pt}
  }{\vspace{6pt}}$else${}{}$endif$

% ----------- T I T L E   P A G E   A N D   P D F   M E T A D A T A -----------
  \hypersetup{
    pdfproducer={ppp (github.com/Thhethssmuz/ppp)},
    pdfcreator={ppp v0.2.3},
    pdfauthor={$for(author)$$author$$sep$, $endfor$},
    pdfsubject={$subject$},
    pdftitle={$title$},
    pdfkeywords={$for(keywords)$$keywords$$sep$, $endfor$}
  }

  \titlehead{
    \makebox[0pt][l]{$title-head-left$}%
    \makebox[\textwidth][l]{\hfill $title-head-centre$\hfill}%
    \makebox[0pt][r]{$title-head-right$}%
  }
  \subject{$subject$}
  \title{$title$}
  \subtitle{$subtitle$}
  \author{$for(author)$$author$$sep$ \and $endfor$}
  \date{$date$}
  \publishers{$publisher$}
  \dedication{$dedication$}

  \newcommand\pppmaketitle{
    \KOMAoptions{titlepage=$if(report)$true$else$false$endif$}
    \pdfbookmark[-1]{$title$}{$title$}
    \maketitle
    $if(report)$$else$
    \vspace{-3em}
    $endif$
  }

  \KOMAoptions{abstract=true}
  \newcommand\pppabstract[2][]{
    \pdfbookmark[$rootlevel$]{\abstractname}{\abstractname}
    $if(report)$$else$
    $if(date)$
    \vspace{1em}
    $else$
    $if(publisher)$
    \vspace{1em}
    $endif$
    $endif$
    \vspace{-3em}
    $endif$
    \begin{abstract}
      $if(report)$
      $else$
      \KOMAoptions{parskip=half}
      \noindent
      \vspace{-4em}
      $endif$

      #2

      \ifthenelse{\equal{#1}{}}{}{\textbf{\keywordsname:} \textnormal{#1}}
    \end{abstract}
  }

% ---------------- T A B L E   O F   C O N T E N T   E T C . . ----------------
  % inline toc depth function
  \newcommand\tocdepth[1]{
    \FPeval{\result}{clip(#1 - 1)}
    \addtocontents{toc}{\protect\setcounter{tocdepth}{\result}}
  }

  \makeatletter
  \newcommand\ppptableofcontents{
    $if(report)$
    \end{pppmulticol}
    $endif$
    \pppclear
    \phantomsection

    \FPeval{\result}{clip($rootlevel$ - 1)}
    \ifnum \value{tocdepth} > \result
      \addcontentsline{toc}{\ifnum $rootlevel$ = 0 chapter\fi\ifnum $rootlevel$ = 1 section\fi}{\contentsname}
    \else
      \bookmark[dest=\@currentHref,level=$rootlevel$]{\contentsname}
    \fi

    \tableofcontents

    \pppclear
    $if(report)$
    \begin{pppmulticol}
    $endif$

    % default toc level for entries after the toc
    % \tocdepth{3}
  }
  \newcommand\ppplistof[1]{
    $if(report)$
    \end{pppmulticol}
    $endif$
    \pppclear
    \phantomsection

    \FPeval{\result}{clip($rootlevel$ - 1)}
    \ifnum \value{tocdepth} > \result
      \addcontentsline{toc}{\ifnum $rootlevel$ = 0 chapter\fi\ifnum $rootlevel$ = 1 section\fi}{\csname list#1name\endcsname}
    \else
      \bookmark[dest=\@currentHref,level=$rootlevel$]{\csname list#1name\endcsname}
    \fi

    \listof{#1}{\csname list#1name\endcsname}

    \pppclear
    $if(report)$
    \begin{pppmulticol}
    $endif$
  }
  \makeatother

% ---------------------------- A P P E N D I C E S ----------------------------
  $if(report)$
  \KOMAoptions{appendixprefix=true}
  $endif$

% --------------------------------- N O T E S ---------------------------------
  % links as notes
  \let\oldhref=\href
  $if(links-as-notes)$
  \renewcommand{\href}[2]{#2\footnote{\url{#1}}}
  $endif$

  \usepackage{fnpct}
  \setfnpct{
    dont-mess-around=true,
    multiple=true
  }

  \usepackage{endnotes}
  \newcommand\pppnotes{

    \begingroup
    \def\enotesize{\normalsize}
    \addtoendnotes{\unexpanded{\enotedivision{}{}}}
    \theendnotes
    \endgroup

    %\setcounter{endnote}{0}% messes up the hyper-refs, ok for print though
  }

% -------------------------- B I B L I O G R A P H Y --------------------------
  \newenvironment{pppbibliography}{
    % show urls in bibliography as links and not as a footnote
    % only applicable if links-as-notes is on
    \let\href=\oldhref
  }{}

% ------------------------------ F I N A L I Z E ------------------------------
  % recalculate page-div after fonts, line lengths, etc. are set
  \KOMAoptions{DIV=current}\recalctypearea

% ------------------------------ D O C U M E N T ------------------------------
\begin{document}

$if(title)$
\pppmaketitle
$endif$

$if(abstract)$
\pppabstract[$if(keywords)$$for(keywords)$$keywords$$sep$, $endfor$$endif$]{$abstract$}
$endif$

\begin{pppmulticol}

\tocdepth{0}

$body$

\tocdepth{10}

\end{pppmulticol}

\end{document}
